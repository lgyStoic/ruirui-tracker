# 锐锐监控系统 - 架构设计

## 一、当前架构（v1）

```
crontab (每分钟)           OpenClaw cron (每10分钟)
    │                              │
    ▼                              ▼
capture.py                    track.py
    │                              │
    ├─ go2rtc → 卧室截图            ├─ 读截图 + 帧差检测
    ├─ go2rtc → 客厅截图            ├─ 采样10张 → Gemini 2.5 Pro
    └─ 萤石云 → 猫眼截图            └─ 写日志 ruirui_YYYY-MM-DD.md
```

### 问题
1. **无容错**：go2rtc 挂了静默失败，萤石 token 过期无告警
2. **无状态机**：每次分析独立，不追踪状态变迁
3. **无告警分级**：所有结果同等对待
4. **猫眼未利用**：门口画面没参与锐锐状态判断
5. **无健康检查**：依赖外部发现故障

## 二、目标架构（v2）

```
┌─────────────────────────────────────────────────┐
│                   调度层 (scheduler.py)            │
│  crontab 每分钟触发，统一管理采集和分析周期            │
└──────────┬──────────────────────┬────────────────┘
           │                      │
     ┌─────▼─────┐         ┌─────▼──────┐
     │ 采集层     │         │ 分析层      │
     │ capture.py │         │ analyze.py  │
     └─────┬─────┘         └─────┬──────┘
           │                      │
    ┌──────┼──────┐               │
    │      │      │               ▼
  go2rtc  go2rtc  萤石       ┌──────────┐
  卧室    客厅    猫眼       │ Gemini   │
                             │ 2.5 Pro  │
                             └────┬─────┘
                                  │
                    ┌─────────────▼──────────────┐
                    │        状态机 (state.py)     │
                    │                             │
                    │  状态: sleeping / playing /  │
                    │  held / eating / crying /   │
                    │  alone_awake / unknown      │
                    │                             │
                    │  上下文: room, companion,    │
                    │  light, duration, door_activity│
                    └─────────────┬──────────────┘
                                  │
                    ┌─────────────▼──────────────┐
                    │       告警层 (alert.py)      │
                    │                             │
                    │  NORMAL  → 静默记录          │
                    │  WATCH   → 加密观察          │
                    │  ALERT   → 飞书通知          │
                    │  URGENT  → 飞书紧急通知      │
                    └────────────────────────────┘
```

## 三、状态机设计

### 状态定义
| 状态 | 含义 | 典型场景 |
|------|------|---------|
| sleeping | 睡觉 | 卧室、蚊帐内、不动 |
| playing | 玩耍 | 客厅/卧室、活跃移动 |
| held | 被抱着 | 大人怀里 |
| eating | 吃奶/辅食 | 餐椅、奶瓶 |
| alone_awake | 独自清醒 | 无大人、婴儿醒着活动 |
| unknown | 无法判断 | 画面看不清/异常 |

### 状态转换触发告警
| 转换 | 告警级别 | 动作 |
|------|---------|------|
| any → sleeping | NORMAL | 记录入睡时间 |
| sleeping → alone_awake | ALERT | 飞书通知"锐锐醒了，没人看" |
| any → alone_awake (>5min) | URGENT | 飞书紧急通知 |
| sleeping (>3h) | WATCH | 飞书提醒"睡了3小时" |
| unknown (>20min) | ALERT | 飞书通知"摄像头可能异常" |
| 猫眼:带锐锐出门 | NORMAL | 记录外出时间，暂停室内监控 |
| 猫眼:带锐锐回家 | NORMAL | 记录回家时间，恢复室内监控 |

## 四、多摄像头融合策略

### 优先级
1. **卧室**：锐锐睡觉时的主摄像头，权重最高
2. **客厅**：锐锐活动时的主摄像头
3. **猫眼**：辅助信息，判断锐锐是否被带出门/回来

### 融合逻辑
- 如果卧室能看到锐锐 → 以卧室为准
- 如果客厅能看到锐锐 → 以客厅为准
- 如果都看不到 → 可能被带出门（结合猫眼）
- 猫眼检测到婴儿车/抱小孩出门 → 标记"外出"
- 猫眼检测到婴儿车/抱小孩回来 → 标记"回家"

## 五、容错设计

### 采集层容错
```python
# 每个摄像头独立重试，互不影响
retry(max=3, backoff=[2,5,10])

# go2rtc 健康检查
GET /api/streams → 检查 producers 状态
如果连续3次失败 → 尝试重启 go2rtc

# 萤石云 token 管理
自动刷新，失败时告警
```

### 分析层容错
```python
# Gemini API 重试
retry(max=2, backoff=[5,15])

# 降级策略
Gemini 失败 → 纯帧差判断（变化大=状态可能变了）

# 结果校验
如果 Gemini 返回格式不对 → 标记 unknown，不更新状态
```

### 系统健康
```python
# 心跳文件
每次成功运行写入 /tmp/ruirui_heartbeat
外部可监控文件修改时间

# 自检
每次运行检查:
- go2rtc 是否在线
- 萤石 token 是否有效
- 磁盘空间是否充足
- 最后成功分析时间
```

## 六、文件结构
```
ruirui_tracker/
├── scheduler.py      # 统一入口，调度采集和分析
├── capture.py        # 采集层：多源抓帧 + 重试
├── analyze.py        # 分析层：Gemini 分析 + 结果解析
├── state.py          # 状态机：状态管理 + 转换逻辑
├── alert.py          # 告警层：分级通知
├── health.py         # 健康检查 + 自愈
├── config.py         # 配置集中管理
└── ARCHITECTURE.md   # 本文档
```
